name: Submit Form on File Update

on:
  push:
    paths-ignore:
      - '.github/**'
      - '.gitignore'
      - '.gitattributes'
      - 'README.md'
      - 'LICENSE'
      - '*.md'
    branches:
      - main

jobs:
  # JOB 1: Gravity Forms Webhook
  notify_gravity_forms:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure full commit history

      - name: Detect files and notify Gravity Forms (snippets only)
        env:
          GF_UPDATE_WEBHOOK_URL: ${{ secrets.GF_UPDATE_WEBHOOK_URL }}
          COMMIT_MESSAGE: "${{ github.event.head_commit.message }}"
        run: |
          set -euo pipefail
          # Include modified (M) and renamed (R) files
          CHANGED_FILES=$(git -c core.quotepath=false diff -M --name-only --diff-filter=MR "${{ github.event.before }}".."${{ github.sha }}")

          # Filter to only real snippet files: *.php or *.js, exclude dotfiles and .github
          FILTERED_FILES=""
          if [ -n "$CHANGED_FILES" ]; then
            while IFS= read -r FILE; do
              [ -z "$FILE" ] && continue
              case "$FILE" in
                .github/*|*/.github/*) continue ;;
                .*) continue ;;
                */.*) continue ;;
                *.php|*.js) FILTERED_FILES="${FILTERED_FILES}"$'\n'"$FILE" ;;
                *) continue ;;
              esac
            done <<< "$CHANGED_FILES"
            FILTERED_FILES=$(echo "$FILTERED_FILES" | sed '/^$/d')
          fi

          if [ -n "$FILTERED_FILES" ]; then
            echo "Processing for Gravity Forms..."
          
            echo "$FILTERED_FILES" | while IFS= read -r FILE; do
              [ -z "$FILE" ] && continue
              FILE_NAME=$(basename "$FILE" | sed 's/\.[^.]*$//')

              # Payload: File Name + Commit Message
              JSON_PAYLOAD=$(jq -n \
                --arg file_name "$FILE_NAME" \
                --arg commit_msg "$COMMIT_MESSAGE" \
                '{input_1: $file_name, input_3: $commit_msg}')

              echo "Sending: $FILE_NAME"
          
              HTTP_STATUS=$(curl -sS -o /tmp/resp_gf.json -w "%{http_code}" -X POST "$GF_UPDATE_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d "$JSON_PAYLOAD")

              if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
                echo "GF Webhook failed ($HTTP_STATUS)"
                cat /tmp/resp_gf.json
                exit 1
              fi
            done
          else
            echo "No relevant files changed."
          fi

  # JOB 2: Update Feed Webhook
  notify_update_feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect files and notify Update Feed (snippets only)
        env:
          UPDATE_FEED_URL: ${{ secrets.UPDATE_FEED_URL }}
          BLD_API_KEY: ${{ secrets.BLD_API_KEY }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          CHANGED_FILES=$(git -c core.quotepath=false diff -M --name-only --diff-filter=MR "${{ github.event.before }}".."${{ github.sha }}")

          # Filter to only real snippet files: *.php or *.js, exclude dotfiles and .github
          FILTERED_FILES=""
          if [ -n "$CHANGED_FILES" ]; then
            while IFS= read -r FILE; do
              [ -z "$FILE" ] && continue
              case "$FILE" in
                .github/*|*/.github/*) continue ;;
                .*) continue ;;
                */.*) continue ;;
                *.php|*.js) FILTERED_FILES="${FILTERED_FILES}"$'\n'"$FILE" ;;
                *) continue ;;
              esac
            done <<< "$CHANGED_FILES"
            FILTERED_FILES=$(echo "$FILTERED_FILES" | sed '/^$/d')
          fi
          
          # Generate Short SHA for a cleaner version number (e.g., "a1b2c3d")
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)

          if [ -n "$FILTERED_FILES" ]; then
            echo "Processing for Update Feed..."

            echo "$FILTERED_FILES" | while IFS= read -r FILE; do
              [ -z "$FILE" ] && continue
              FILE_NAME=$(basename "$FILE" | sed 's/\.[^.]*$//')

              # Payload: Item Key + Short SHA as Version
              JSON_PAYLOAD=$(jq -n \
                --arg file_name "$FILE_NAME" \
                --arg ver "$SHORT_SHA" \
                '{item_updated: $file_name, version: $ver}')

              echo "Sending: $FILE_NAME (v$SHORT_SHA)"

              HTTP_STATUS=$(curl -sS -o /tmp/resp_feed.json -w "%{http_code}" -X POST "$UPDATE_FEED_URL" \
                -H "Content-Type: application/json" \
                -H "X-API-Key: $BLD_API_KEY" \
                -d "$JSON_PAYLOAD")

              if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
                echo "Feed Webhook failed ($HTTP_STATUS)"
                cat /tmp/resp_feed.json
                exit 1
              fi
            done
          else
            echo "No relevant files changed."
          fi