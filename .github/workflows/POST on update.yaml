name: Submit Form on File Update

on:
  push:
    paths-ignore:
      - '.github/workflows/**'
    branches:
      - main

jobs:
  submit_updated_file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure full commit history

      - name: Detect updated/renamed files and submit form
        env:
          GF_UPDATE_WEBHOOK_URL: ${{ secrets.GF_UPDATE_WEBHOOK_URL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: "${{ github.event.head_commit.message }}"  # Store commit message in env variable
        run: |
          set -euo pipefail
          # Include modified (M) and renamed (R) files
          CHANGED_FILES=$(git diff -M --name-only --diff-filter=MR "${{ github.event.before }}".."${{ github.sha }}")

          if [ -n "$CHANGED_FILES" ]; then
            echo "Changed files detected (modified or renamed):"
            echo "$CHANGED_FILES"
            echo "Commit Message: $COMMIT_MESSAGE"

            while IFS= read -r FILE; do
              [ -z "$FILE" ] && continue

              FILE_NAME=$(basename "$FILE")
              FILE_NAME=${FILE_NAME%.*}

              JSON_PAYLOAD=$(jq -n \
                --arg file_name "$FILE_NAME" \
                --arg commit_msg "$COMMIT_MESSAGE" \
                '{input_1: $file_name, input_3: $commit_msg}')

              echo "Submitting data for: $FILE_NAME"
              
              HTTP_STATUS=$(curl -sS -o /tmp/resp.json -w "%{http_code}" -X POST "$GF_UPDATE_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD")
  
              if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
                echo "Webhook failed ($HTTP_STATUS):"
                cat /tmp/resp.json || true
                exit 1
              fi
            done <<< "$CHANGED_FILES"
          else
            echo "No modified or renamed files detected."
          fi