name: Submit Form on File Update

on:
  push:
    paths-ignore:
      - '.github/workflows/**'
    branches:
      - main

jobs:
  submit_updated_file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Ensure full commit history

      - name: Detect updated files and submit form
        env:
          GF_UPDATE_WEBHOOK_URL: ${{ secrets.GF_UPDATE_WEBHOOK_URL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          # Find files that were updated (not created) and wrap them in quotes
          UPDATED_FILES=$(git diff --name-only --diff-filter=M ${{ github.event.before }}..HEAD | sed 's/^/"/;s/$/"/')

          if [ -n "$UPDATED_FILES" ]; then
            echo "Updated files detected:"
            echo "$UPDATED_FILES"

            while IFS= read -r FILE; do
              FILE_NAME=$(basename "$FILE")
              COMMIT_MESSAGE=$(git log -1 --pretty=format:%s)

              JSON_PAYLOAD=$(jq -n \
                --arg file_name "$FILE_NAME" \
                --arg commit_msg "$COMMIT_MESSAGE" \
                '{input_1: $file_name, input_2: $commit_msg}')

              echo "Submitting data for: $FILE_NAME"
              echo "Commit Message: $COMMIT_MESSAGE"

              curl -X POST "$GF_UPDATE_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d "$JSON_PAYLOAD"
            done <<< "$UPDATED_FILES"
          else
            echo "No updated files detected."
          fi
